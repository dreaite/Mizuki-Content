# Notion Sync (Posts)

[中文说明（简体）](./README.zh-CN.md)

This repository includes a GitHub Action that syncs content from a Notion database into:

- `posts/` (blog posts)
- `spec/about.md` (about page)
- `data/friends.ts` (friend links)
- `data/diary.ts` (diary data)
- `data/projects.ts` (project cards)

## Files

- Workflow: `.github/workflows/sync-notion-posts.yml`
- Sync script: `.github/scripts/sync-notion-posts.mjs`

## Goal

Keep local content files consistent with the Notion database by `type`.

- Notion `Post` pages are converted to Markdown and written to `posts/`
- Notion `About` page (latest updated if multiple) is written to `spec/about.md`
- Notion `Friend` pages are mapped into `data/friends.ts`
- Notion `Diary` pages are mapped into `data/diary.ts`
- Notion `Project` pages are mapped into `data/projects.ts`
- Existing files are updated when content/front matter changes
- Files missing from Notion are deleted (when `NOTION_SYNC_DELETE_MISSING=true`)
- When posts are changed and pushed, the workflow can directly trigger Cloudflare Pages Deploy Hook (`CF_DEPLOY_HOOK`)

## Required GitHub Secrets

- `NOTION_TOKEN`
- `NOTION_DATABASE_ID`
- `CF_DEPLOY_HOOK` (if using the built-in Cloudflare deploy hook step in `sync-notion-posts.yml`)
- `NOTION_POST_TRANSLATION_API_KEY` (only when enabling LLM translation)
- `NOTION_COVER_R2_ACCESS_KEY_ID` / `NOTION_COVER_R2_SECRET_ACCESS_KEY` (only when enabling R2 cover sync)

## Optional GitHub Variables

- `NOTION_DATA_SOURCE_ID`
  - Recommended when using newer Notion API / SDK v5 and your database contains multiple data sources.
  - If omitted, the script will try to resolve a data source automatically from `NOTION_DATABASE_ID`.
- `NOTION_POST_TRANSLATION_ENABLED`
  - Set to `true` to enable translating `Post` markdown body via an OpenAI-compatible Chat Completions API.
- `NOTION_POST_TRANSLATION_LANGS`
  - Comma-separated target language codes, e.g. `en,ja`.
- `NOTION_POST_TRANSLATION_MODEL`
  - Model name used for translation requests.
- `NOTION_POST_TRANSLATION_API_BASE_URL`
  - Optional API base URL, default: `https://api.openai.com/v1`.
- `NOTION_POST_TRANSLATION_TIMEOUT_MS`
  - Optional LLM translation request timeout in milliseconds.
  - Default `600000` (10 minutes). Increase for long posts (e.g. `900000` = 15 minutes).
- `NOTION_POST_TRANSLATION_SOURCE_LANG`
  - Optional source language hint (prompt context only), e.g. `zh-cn`.
- `NOTION_POST_TRANSLATION_SYSTEM_PROMPT`
  - Optional custom system prompt for translation behavior.
- `NOTION_COVER_R2_ENABLED`
  - Set to `true` to upload Notion image assets to Cloudflare R2 and write stable public URLs.
  - Covers:
    - `Post` cover image (`frontmatter.image`)
    - `Project` cover image fields in generated TS data
    - Markdown body images in `Post`, `About`, and `Diary` content (including diary extracted `images`)
- `NOTION_COVER_R2_ENDPOINT`
  - R2 S3 API endpoint, e.g. `https://<accountid>.r2.cloudflarestorage.com`.
- `NOTION_COVER_R2_REGION`
  - Usually `auto` for R2.
- `NOTION_COVER_R2_BUCKET`
  - R2 bucket name used to store cover images.
- `NOTION_COVER_R2_PUBLIC_BASE_URL`
  - Public URL base for the bucket (custom domain or `*.r2.dev`), e.g. `https://static.example.com`.
- `NOTION_COVER_R2_PREFIX`
  - Optional object key prefix (default `notion/covers`).
- `NOTION_COVER_R2_CACHE_CONTROL`
  - Optional uploaded object cache header (default `public, max-age=3600`).

## Notion Database Property Mapping (default names)

The workflow passes these defaults. Change them in the workflow if your column names differ.

- `type` -> content type router (`Post` / `About` / `Friend` / `Diary` / `Project`)
- `title` -> front matter `title`
- `createTime` -> front matter `published` (date only `YYYY-MM-DD`)
- `date` -> front matter `updated` (date only `YYYY-MM-DD`)
- `summary` -> front matter `description`
- `slug` -> front matter `permalink` and output filename
- page cover -> front matter `image`
- `tags` -> front matter `tags`
- `category` -> front matter `category`
- `status` -> front matter `draft` (`Draft` => `true`)

Additional mappings:

- `type = About` -> writes markdown body to `spec/about.md`
- `type = Friend`
  - `id`: generated by updated-time sort order (newest first)
  - `title`: Notion `title`
  - `imgurl`: page cover URL
  - `desc`: Notion `summary`
  - `siteurl`: Notion `url`
  - `tags`: Notion `tags`
- `type = Diary`
  - `id`: generated by updated-time sort order (newest first)
  - `content`: markdown body with image blocks removed (text/newlines preserved)
  - `date`: Notion `updateTime` (ISO 8601 UTC string, fallback `last_edited_time`)
  - `images`: extracted image URLs from body
- `type = Project`
  - `id`: Notion `title` string
  - `title`: Notion `title`
  - `description`: Notion `summary`
  - `image`: page cover URL
  - `startDate` / `endDate`: Notion `date` (`endDate` only when end exists)
  - `category`: Notion `category`
  - `techStack`: Notion `techStack`
  - `status`: Notion `status`
  - `featured`: Notion `featured` (`true`/`false` select, empty means omit)
  - `liveDemo`: Notion `liveDemo`
  - `sourceCode`: Notion `url`
  - `tags`: Notion `tags`

## Expected Notion Property Types

Recommended types:

- `type`: `select` or `status` or `rich_text`
- `title`: `title`
- `createTime`: `created time` (or any property that can resolve to a date/time string)
- `date`: `date`
- `summary`: `rich_text`
- `slug`: `rich_text` or `formula`
- `tags`: `multi_select`
- `category`: `select` (or `multi_select`, first value will be used)
- `status`: `status` or `select`
- `techStack`: `multi_select` (recommended)
- `featured`: `select` (values: empty / `false` / `true`)
- `liveDemo`: `url` or `rich_text`

## Deletion Behavior (Important)

The workflow currently sets:

- `NOTION_SYNC_DELETE_MISSING=true`

This means:

- Any `*.md` file under `posts/` that is **not** produced from a current Notion `Post` page will be deleted on sync.

If you still have manually maintained posts under `posts/`, either:

1. Move them out of `posts/`, or
2. Change `NOTION_SYNC_DELETE_MISSING` to `'false'` in `.github/workflows/sync-notion-posts.yml`

## Filename Rules

- Output path is derived from `slug`
- `slug` supports nested paths (example: `guide/intro` -> `posts/guide/intro.md`)
- `.md` is appended automatically if missing
- When translation is enabled, translated posts are written next to the source file using `${filename}.${lang}.md`
  - Example: `posts/guide/intro.md` -> `posts/guide/intro.en.md`
  - The translated file frontmatter adds `lang: '<lang>'`
  - The translated file does not write a frontmatter `permalink` (route comes from the translated filename)

## Post Translation Behavior (LLM)

- Only translates `type = Post`
- Skips translation when the post is a draft (`draft: true`)
- Translates the Markdown **body** and frontmatter `title` / `description`
- Translation runs when the source post is created/updated by the normal Notion sync flow
- If a translated file for a configured language is missing, it will be created the next time that post is processed by sync
- If `NOTION_SYNC_DELETE_MISSING=true`, stale translated `*.{lang}.md` files are also deleted when they are no longer produced (for example, source post removed or language removed from config)

## Running

- Manual run: GitHub Actions -> `Sync Notion Posts` -> `Run workflow`
- Optional schedule is included as a commented `cron` entry in the workflow

## Notes

- Notion cover/file URLs are often temporary signed URLs and may expire.
- When `NOTION_COVER_R2_ENABLED=true`, the sync script uploads Notion image assets to R2 and stores R2 public URLs instead of temporary signed Notion URLs.
- Existing `Post` / `About` markdown files with expired Notion image URLs are backfilled to R2 URLs during later sync runs (even if the body did not change).
- The workflow auto-commits `posts/` changes back to the current branch.
- `Friend` / `Diary` data files are regenerated from current Notion rows each run (then `writeIfChanged` avoids no-op writes) so ordering-based IDs stay consistent.
- `Project` data file (`data/projects.ts`) is also regenerated each run to keep the local dataset aligned with current Notion rows.
- The workflow installs `@notionhq/client@5` (major pinned) to reduce future breaking changes from automatic upgrades.

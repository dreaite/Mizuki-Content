name: Sync Notion Posts

on:
  workflow_dispatch:
  #schedule:
  #  - cron: '*/15 * * * *' # 可选：每小时同步一次

permissions:
  contents: write

concurrency:
  group: sync-notion-posts
  cancel-in-progress: false

jobs:
  sync:
    runs-on: selfN100
    timeout-minutes: 500

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install sync dependencies
        run: npm install --no-save --no-package-lock @notionhq/client@5 notion-to-md @aws-sdk/client-s3 undici

      - name: Sync posts from Notion database
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          # 可选（Notion SDK v5 且一个 database 下有多个 data source 时建议显式配置）
          NOTION_DATA_SOURCE_ID: ${{ secrets.NOTION_DATA_SOURCE_ID }}
          NOTION_SYNC_DELETE_MISSING: 'true'
          # 同步窗口 = cron 周期 * 2（分钟）
          NOTION_SYNC_CRON_MINUTES: '60'
          NOTION_SYNC_LOOKBACK_MULTIPLIER: '2'
          # 可选：如果你的 Notion 数据库列名不同，可在仓库 Variables 中覆盖这些值
          NOTION_POSTS_DIR: posts
          NOTION_ABOUT_PATH: spec/about.md
          NOTION_FRIENDS_DATA_PATH: data/friends.ts
          NOTION_DIARY_DATA_PATH: data/diary.ts
          NOTION_PROJECTS_DATA_PATH: data/projects.ts
          # 可选：启用 Post 正文翻译（OpenAI-compatible Chat Completions API）
          NOTION_POST_TRANSLATION_ENABLED: ${{ secrets.NOTION_POST_TRANSLATION_ENABLED || 'false' }}
          # 逗号分隔语言代码，例如：en,ja
          NOTION_POST_TRANSLATION_LANGS: ${{ secrets.NOTION_POST_TRANSLATION_LANGS || '' }}
          NOTION_POST_TRANSLATION_MODEL: ${{ secrets.NOTION_POST_TRANSLATION_MODEL || '' }}
          NOTION_POST_TRANSLATION_API_BASE_URL: ${{ secrets.NOTION_POST_TRANSLATION_API_BASE_URL || 'https://api.openai.com/v1' }}
          # 可选：LLM 翻译请求超时时间（毫秒），长文可调大，例如 900000 = 15 分钟
          NOTION_POST_TRANSLATION_TIMEOUT_MS: ${{ secrets.NOTION_POST_TRANSLATION_TIMEOUT_MS || '600000' }}
          # 可选：源语言（仅作为提示词上下文），例如 zh-cn
          NOTION_POST_TRANSLATION_SOURCE_LANG: ${{ secrets.NOTION_POST_TRANSLATION_SOURCE_LANG || '' }}
          # 可选：自定义 system prompt（不填则使用脚本内默认提示词）
          NOTION_POST_TRANSLATION_SYSTEM_PROMPT: ${{ secrets.NOTION_POST_TRANSLATION_SYSTEM_PROMPT || '' }}
          NOTION_POST_TRANSLATION_API_KEY: ${{ secrets.NOTION_POST_TRANSLATION_API_KEY }}
          # 可选：将 Notion 图片资产（Post/Project 封面 + Post/About/Diary 正文图片）上传到 Cloudflare R2，并写入稳定公网 URL
          NOTION_COVER_R2_ENABLED: ${{ secrets.NOTION_COVER_R2_ENABLED || 'false' }}
          NOTION_COVER_R2_ENDPOINT: ${{ secrets.NOTION_COVER_R2_ENDPOINT || '' }}
          NOTION_COVER_R2_REGION: ${{ secrets.NOTION_COVER_R2_REGION || 'auto' }}
          NOTION_COVER_R2_BUCKET: ${{ secrets.NOTION_COVER_R2_BUCKET || '' }}
          # 公开访问域名（例如自定义域名或 r2.dev 域名），脚本会在其后拼接对象 key
          NOTION_COVER_R2_PUBLIC_BASE_URL: ${{ secrets.NOTION_COVER_R2_PUBLIC_BASE_URL || '' }}
          NOTION_COVER_R2_PREFIX: ${{ secrets.NOTION_COVER_R2_PREFIX || 'notion/covers' }}
          NOTION_COVER_R2_CACHE_CONTROL: ${{ secrets.NOTION_COVER_R2_CACHE_CONTROL || 'public, max-age=3600' }}
          NOTION_COVER_R2_ACCESS_KEY_ID: ${{ secrets.NOTION_COVER_R2_ACCESS_KEY_ID }}
          NOTION_COVER_R2_SECRET_ACCESS_KEY: ${{ secrets.NOTION_COVER_R2_SECRET_ACCESS_KEY }}
          NOTION_TYPE_PROPERTY: type
          NOTION_TITLE_PROPERTY: title
          NOTION_CREATE_TIME_PROPERTY: createTime
          NOTION_UPDATED_DATE_PROPERTY: date
          NOTION_UPDATE_TIME_PROPERTY: updateTime
          NOTION_SUMMARY_PROPERTY: summary
          NOTION_SLUG_PROPERTY: slug
          NOTION_URL_PROPERTY: url
          NOTION_LIVE_DEMO_PROPERTY: liveDemo
          NOTION_TECH_STACK_PROPERTY: techStack
          NOTION_FEATURED_PROPERTY: featured
          NOTION_TAGS_PROPERTY: tags
          NOTION_CATEGORY_PROPERTY: category
          NOTION_STATUS_PROPERTY: status
        run: node .github/scripts/sync-notion-posts.mjs

      - name: Commit and push changes
        id: commit_push
        run: |
          if [ -z "$(git status --porcelain -- posts spec/about.md data/friends.ts data/diary.ts data/projects.ts)" ]; then
            echo "No content changes in posts/about/data"
            echo "pushed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A posts spec/about.md data/friends.ts data/diary.ts data/projects.ts
          git commit -m "chore(content): sync notion content"
          git push
          echo "pushed=true" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Trigger Cloudflare Pages Deploy Hook
        if: ${{ steps.commit_push.outputs.pushed == 'true' }}
        env:
          CF_DEPLOY_HOOK: ${{ secrets.CF_DEPLOY_HOOK }}
        run: |
          if [ -z "$CF_DEPLOY_HOOK" ]; then
            echo "❌ CF_DEPLOY_HOOK secret is not set"
            exit 1
          fi

          response=$(curl -s -w "\n%{http_code}" -X POST "$CF_DEPLOY_HOOK")
          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "✅ Cloudflare Pages deployment triggered successfully"
          else
            echo "❌ Failed to trigger deployment. HTTP code: $http_code"
            exit 1
          fi

      - name: Job summary
        if: always()
        env:
          POSTS_PUSHED: ${{ steps.commit_push.outputs.pushed || 'false' }}
          SYNC_COMMIT_SHA: ${{ steps.commit_push.outputs.commit_sha || '' }}
        run: |
          echo "## Notion Sync" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Workflow run: \`${{ github.run_id }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Ref: \`${{ github.ref_name }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Content updated and pushed: \`${POSTS_PUSHED}\`" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "$SYNC_COMMIT_SHA" ]; then
            echo "- Sync commit SHA: \`${SYNC_COMMIT_SHA}\`" >> "$GITHUB_STEP_SUMMARY"
          fi

---
title: '实验5 电子邮件'
published: 2022-07-01
updated: 2022-07-01
description: '实验旨在理解电子邮件系统的基本结构和通信协议，包括SMTP和POP3。通过使用邮件代理、客户端、Web邮件和telnet命令进行邮件收发，分析其通信过程和协议。实验结果表明，掌握了邮件发送的具体流程和SMTP协议的分析，提高了编程能力和对协议的理解。'
permalink: 'email-experiment-2022'
image: 'https://r2.dreaife.tokyo/notion/covers/04494c67f6c14b5d8a184b32d9acc165/663438ca13025ac9.jpg'
tags: ['network', 'school']
category: 'cs-base'
draft: false
lang: 'en'
---

## **1. Objectives**

- Understand the basic structure of email systems
- Understand the client and server sides, and the communication between servers
- Analyze and understand the SMTP and POP3 protocols

## **2. Experimental Environment**

- Hardware requirements: One Alibaba Cloud ECS instance
- Software requirements: Linux/Windows operating systems

## **3. Experimental Content**

### **3.1 Using a Mail Client to Send/Receive Mail**

Configure a mail user agent (for example, Windows, Outlook, Express, Thunderbird on Linux, etc.; you can use the one that comes with the system or download it yourself), to compose locally and receive your QQ Mail.

### **3.2 Local Email Sending/Receiving**

Use a local client to compose and send QQ emails. At the same time, use Wireshark to capture packets and analyze its communication process and protocols.

### **3.3 Web Mail**

Use a browser to log in to QQ Mail, compose and send QQ emails. Also use Wireshark to capture packets and analyze the communication process and protocols.

### **3.4 Telnet Email Sending/Receiving**

Use the telnet command to log in to the QQ Mail server and send emails. Also use Wireshark to capture packets to analyze the communication process and protocols.

Refer to online resources for the exact commands and port queries.

## **4. Results and Analysis**

### **4.1 Using a Mail Client to Send/Receive Mail**

1. Open QQ Mail, enable POP3/SMTP services, and obtain an authorization code.

![WAPvTMgEO7DYlX9.png](https://s2.loli.net/2022/06/06/WAPvTMgEO7DYlX9.png)

1. Follow the instructions provided by QQ Mail to bind Outlook to QQ Mail

![nyDNv6BM2EXT8W4.png](https://s2.loli.net/2022/06/06/nyDNv6BM2EXT8W4.png)


### **4.2 Local Email Sending/Receiving**

1. Disable account SSL

![pdY93TjtRnJUafk.png](https://s2.loli.net/2022/06/06/pdY93TjtRnJUafk.png)

1. Use Wireshark to capture packets on the WLAN and send emails

![e5dzHk21IfX4xBa.png](https://s2.loli.net/2022/06/06/e5dzHk21IfX4xBa.png)

1. Use Wireshark to trace SMTP

![L83wZDIPviyQljA.png](https://s2.loli.net/2022/06/06/L83wZDIPviyQljA.png)

1. Analyze the communication process and protocols

```plain text
C: telnet imap.qq.com 25                                                //Connect to QQ mail server via telnet
S: 220 newxmesmtplogicsvrszc10.qq.com XMail Esmtp QQ Mail Server.       //Connection successful, 220 is the status code, followed by welcome message
C: EHLO DREAIFEDESKTOP                                                  //Identify to the server
S: 250-newxmesmtplogicsvrszc10.qq.com | PIPELINING | SIZE 73400320 | STARTTLS | AUTH LOGIN PLAIN XOAUTH XOAUTH2 | AUTH=LOGIN | MAILCOMPRESS | 8BITMIME                                                  //Success
C: AUTH LOGIN                                                           //Login
S: 334 VXNlcm5hbWU6
C: User: ODc3MjYxNzkzQHFxLmNvbQ==                                       //Base64 of username and authorization code
S: 334 UGFzc3dvcmQ6
C: Pass: enVqbnVobWFhcnB5YmJiYg==
S: 235 Authentication successful
C: MAIL FROM: <877261793@qq.com>                                        //Sender email
S: 250 OK
C: RCPT TO: <877261793@qq.com>                                          //Recipient email
S: 250 OK
C: DATA                                                                 //Email content
S: 354 End data with <CR><LF>.<CR><LF>.
C: DATA fragment, 2429 bytes
from: <877261793@qq.com>, subject:  ,  (text/plain) (text/html)
S: 250 OK: queued as.
C: QUIT                                                                 //Send complete and exit
S：221 Bye
```


### **4.3 Web Mail**

1. Use Wireshark to capture packets on the WLAN and send email

![9yA3gaBJip5nZFx.png](https://s2.loli.net/2022/06/06/9yA3gaBJip5nZFx.png)

1. Use Wireshark to trace TLS/SSL

![f56VQIEgGpxHtyr.png](https://s2.loli.net/2022/06/06/f56VQIEgGpxHtyr.png)

1. Analyze the communication process and protocols
> Client Hello
>
> ![SPGzmxOXKJpVorj.png](https://s2.loli.net/2022/06/06/SPGzmxOXKJpVorj.png)
>
>
> The first step of the TLS handshake is the client initiating the request, mainly including the random string generated by the client (session key), as well as the list of cipher suites supported by the client, random numbers, and other information.
>
>
> ![MUh98dIWNmpn1Lc.png](https://s2.loli.net/2022/06/06/MUh98dIWNmpn1Lc.png)
>
> 1. Server Hello && Certificate
>
> ![Aa2ZoQi6EhGBbeR.png](https://s2.loli.net/2022/06/06/Aa2ZoQi6EhGBbeR.png)
>
>
> After receiving the Client Hello data from the client, the server selects a cipher suite from the client's list and generates a random string to return to the client. The key exchange algorithm chosen is ECDHE_RSA, the symmetric encryption algorithm uses AES_128_GCM_SHA256, and the server’s certificate information is also returned.
>
>
> ![phEZKM1VHBfUAdt.png](https://s2.loli.net/2022/06/06/phEZKM1VHBfUAdt.png)
>
> 1. Server Key Exchange & Server Hello Done
>
> ![3RYzrJUFaiPZKAM.png](https://s2.loli.net/2022/06/06/3RYzrJUFaiPZKAM.png)
>
>
> The server returns a Server Key Exchange packet to exchange the keys used for data encryption with the client, and Server Hello Done to notify the client that the data for key exchange has been sent and to wait for the client’s response.
>
>
> ![EvhOaj35WegzYoF.png](https://s2.loli.net/2022/06/06/EvhOaj35WegzYoF.png)
>
> 1. Client Key Change & Change Cipher Spec & Encrypted HandShake Message
>
> ![w1rncSCU9YBhsiR.png](https://s2.loli.net/2022/06/06/w1rncSCU9YBhsiR.png)
>
>
> The client uses the server-provided DH data to generate DH data and send it to the server to generate the final pre-master secret. As shown:
>
>
> ![7GXgdnSAIuFOCfe.png](https://s2.loli.net/2022/06/06/7GXgdnSAIuFOCfe.png)
>
> 1. Application Data
>
> ![QZ9AqUsz3n7NGSw.png](https://s2.loli.net/2022/06/06/QZ9AqUsz3n7NGSw.png)
>
> 1. Change Cipher Spec & Encrypted HandShake Message
>
> ![TjVrHfLqJBPXeYc.png](https://s2.loli.net/2022/06/06/TjVrHfLqJBPXeYc.png)
>
>
> Session keys should be refreshed periodically
>
>
> ![rwfkcnzlxQ1DBSL.png](https://s2.loli.net/2022/06/06/rwfkcnzlxQ1DBSL.png)
>

### **4.4 Telnet Email Sending/Receiving**

1. Enable Telnet on the computer and use Wireshark to capture packets

![DldVe27vhCkrOQ4.png](https://s2.loli.net/2022/06/06/DldVe27vhCkrOQ4.png)

1. Open cmd to operate
> Enter telnet imap.qq.com 25 to connect to the server and input the following commands
>
> ![bOlcSHmnQYNGPyq.png](https://s2.loli.net/2022/06/06/bOlcSHmnQYNGPyq.png)
>
> 1. Email sending completed
>
> ![SGZ1ThwLfAgRnIU.png](https://s2.loli.net/2022/06/06/SGZ1ThwLfAgRnIU.png)

1. Analyze the communication process and protocols

```plain text
C: telnet imap.qq.com 25                                                //Connect to QQ mail server via telnet
S: 220 newxmesmtplogicsvrszc10.qq.com XMail Esmtp QQ Mail Server.       //Connection successful, 220 is the status code, followed by welcome message
C: helo qq.com                                                          //Identify to the server
S: 250-newxmesmtplogicsvrsza5.qq.com-9.22.14.83-57293480
S: 250-SIZE 73400320
S: 250 OK                                                               //Success
C: auth login                                                           //Login
S: 334 VXNlcm5hbWU6
C: User: ODc3MjYxNzkzQHFxLmNvbQ==                                       //Base64 of username and authorization code
S: 334 UGFzc3dvcmQ6
C: Pass: enVqbnVobWFhcnB5YmJiYg==
S: 235 Authentication successful
C: MAIL FROM: <877261793@qq.com>                                        //Sender email
S: 250 OK
C: RCPT TO: <877261793@qq.com>                                          //Recipient email
S: 250 OK
C: DATA                                                                 //Email content
S: 354 End data with <CR><LF>.<CR><LF>.
C: DATA fragment, 2429 bytes
from: <877261793@qq.com>, subject:  ,  (text/plain) (text/html)
S: 250 OK: queued as.
C: QUIT                                                                 //Send complete and exit
S：221 Bye
```

## **5. Conclusions**

### **5.1 Problems and Solutions**

> The issue when using Xftp to connect to the server: connection errors; the solution was to switch to campus network, after which it returned to normal. Investigation showed it was due to the server firewall.

### **5.2 Reflections**

- This lab report familiarizes the actions of code and software involved in SMTP protocol analysis, as well as the analysis and extraction of SMTP messages, validating the knowledge learned in class. Through this experiment, I mastered the concrete process and steps of sending emails via Telnet, understood the basic usage of common SMTP protocol analysis tools, and improved my programming ability.
- Through these common SMTP protocol analysis commands, tracking SMTP usage, and analyzing the structure of SMTP messages, I reinforced the knowledge taught in class.
